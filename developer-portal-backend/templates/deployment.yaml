---

apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: {{ template "developer-portal-backend.fullname" . }}
  labels:
    app: {{ template "developer-portal-backend.name" . }}
    chart: {{ template "developer-portal-backend.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  replicas: {{ .Values.developerPortalBackend.replicaCount }}
  selector:
    matchLabels:
      app: {{ template "developer-portal-backend.name" . }}
      release: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ template "developer-portal-backend.name" . }}
        release: {{ .Release.Name }}
    spec:
      containers:
        - name: developer-portal-backend
          image: "{{ .Values.global.registry }}{{ .Values.developerPortalBackend.images.backend.repository }}:{{ tpl .Values.developerPortalBackend.images.backend.tag . }}"
          imagePullPolicy: {{ .Values.developerPortalBackend.images.pullPolicy }}
          env:
            - name: ADMIN_API_URL
              value: "{{ .Values.developerPortalBackend.env.admin_apim_url }}"
            - name: ADMIN_API_KEY
              value: "{{ .Values.developerPortalBackend.env.admin_api_key }}"
            - name: APIM_PRODUCT_NAME
              value: "{{ .Values.developerPortalBackend.env.apim_product_name }}"
            - name: APIM_USER_GROUPS
              value: "{{ .Values.developerPortalBackend.env.apim_user_groups }}"
            - name: APPINSIGHTS_INSTRUMENTATIONKEY
              value: "{{ .Values.developerPortalBackend.env.appinsights_instrumentationkey }}"
            - name: ARM_APIM
              value: "{{ .Values.developerPortalBackend.env.arm_apim }}"
            - name: ARM_RESOURCE_GROUP
              value: "{{ .Values.developerPortalBackend.env.arm_resource_group }}"
            - name: ARM_SUBSCRIPTION_ID
              value: "{{ .Values.developerPortalBackend.env.arm_subscription_id }}"
            - name: ARM_TENANT_ID
              value: "{{ .Values.developerPortalBackend.env.arm_tenant_id }}"
            - name: USE_SERVICE_PRINCIPAL
              value: "{{ .Values.developerPortalBackend.env.use_service_principal }}"
            - name: SERVICE_PRINCIPAL_CLIENT_ID
              value: "{{ .Values.developerPortalBackend.env.service_principal_client_id }}"
            - name: SERVICE_PRINCIPAL_SECRET
              value: "{{ .Values.developerPortalBackend.env.service_principal_client_secret }}"
            - name: CLIENT_NAME
              value: "{{ .Values.developerPortalBackend.env.client_name }}"
            - name: CLIENT_ID
              value: "{{ .Values.developerPortalBackend.env.client_id }}"
            - name: CLIENT_SECRET
              value: "{{ .Values.developerPortalBackend.env.client_secret }}"
            - name: COOKIE_IV
              value: "{{ .Values.developerPortalBackend.env.cookie_iv }}"
            - name: COOKIE_KEY
              value: "{{ .Values.developerPortalBackend.env.cookie_key }}"
            - name: LOG_LEVEL
              value: "{{ .Values.developerPortalBackend.env.log_level }}"
            - name: POLICY_NAME
              value: "{{ .Values.developerPortalBackend.env.policy_name }}"
            - name: RESET_PASSWORD_POLICY_NAME
              value: "{{ .Values.developerPortalBackend.env.reset_password_policy_name }}"
            - name: POST_LOGIN_URL
              value: "{{ .Values.developerPortalBackend.env.post_login_url }}"
            - name: POST_LOGOUT_URL
              value: "{{ .Values.developerPortalBackend.env.post_logout_url }}"
            - name: REPLY_URL
              value: "{{ .Values.developerPortalBackend.env.reply_url }}"
            - name: TENANT_ID
              value: "{{ .Values.developerPortalBackend.env.tenant_id }}"
            - name: WEBSITE_NODE_DEFAULT_VERSION
              value: "{{ .Values.developerPortalBackend.env.website_node_default_version }}"
            - name: WEBSITE_NPM_DEFAULT_VERSION
              value: "{{ .Values.developerPortalBackend.env.website_npm_default_version }}"
          ports:
            - name: backend-http
              containerPort: {{ .Values.developerPortalBackend.services.backendHttp.port }}
              protocol: {{ .Values.developerPortalBackend.services.backendHttp.protocol }}
          resources:
{{ toYaml .Values.developerPortalBackend.resources.backend | indent 12 }}
    {{- with .Values.developerPortalBackend.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.developerPortalBackend.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.developerPortalBackend.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
